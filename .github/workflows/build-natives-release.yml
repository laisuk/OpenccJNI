name: Build OpenccWrapper natives and release

on:
  push:
    tags:
      - "v*" # e.g. v1.0.0-beta1
  workflow_dispatch:

permissions:
  contents: read

env:
  # JNI sources live alongside Java in the openccjni package dir
  CPP_SRC: openccjni/src/main/java/openccjni/OpenccWrapper.cpp
  JAVA_SRC_CLASS: openccjni/src/main/java/openccjni/OpenccWrapper.java openccjni/src/main/java/openccjni/OpenccConfig.java

  # C headers (generated + capi header) live with java sources
  CAPI_INCLUDE: openccjni/src/main/java/openccjni

  # Link against the CAPI that is shipped under resources
  LINUX_LIB_DIR: openccjni/src/main/resources/openccjni/natives/linux-x86_64
  MACOS_ARM64_LIB_DIR: openccjni/src/main/resources/openccjni/natives/macos-arm64
  MACOS_X86_64_LIB_DIR: openccjni/src/main/resources/openccjni/natives/macos-x86_64

  # Library name for -l<name> (maps to libopencc_fmmseg_capi.{so,dylib})
  CAPI_LIB_NAME: opencc_fmmseg_capi

jobs:
  build_natives:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux x86_64 .so
            runs_on: ubuntu-latest
            platform: linux-x86_64
            wrapper_out: build/linux-x86_64/libOpenccWrapper.so
            capi_dir: openccjni/src/main/resources/openccjni/natives/linux-x86_64
            capi_file: libopencc_fmmseg_capi.so
            cc: g++
            java_os_include: linux
            extra_setup: |
              sudo apt-get update
              sudo apt-get install -y build-essential zip

          - name: macOS arm64 .dylib
            runs_on: macos-latest
            platform: macos-arm64
            wrapper_out: build/macos-arm64/libOpenccWrapper.dylib
            capi_dir: openccjni/src/main/resources/openccjni/natives/macos-arm64
            capi_file: libopencc_fmmseg_capi.dylib
            cc: clang++
            java_os_include: darwin
            extra_setup: ""

          - name: macOS x86_64 .dylib
            runs_on: macos-15-intel
            platform: macos-x86_64
            wrapper_out: build/macos-x86_64/libOpenccWrapper.dylib
            capi_dir: openccjni/src/main/resources/openccjni/natives/macos-x86_64
            capi_file: libopencc_fmmseg_capi.dylib
            cc: clang++
            java_os_include: darwin
            extra_setup: ""

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Java 17 (for JNI headers)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install build tools (Linux only)
        if: ${{ runner.os == 'Linux' }}
        run: ${{ matrix.extra_setup }}

      - name: Show tree for sanity
        shell: bash
        run: |
          ls -la openccjni/src/main/java/openccjni || true
          ls -la "${{ matrix.capi_dir }}" || true

      - name: Generate JNI header (optional)
        shell: bash
        run: |
          javac -h . ${{ env.JAVA_SRC_CLASS }}

      - name: Build wrapper
        shell: bash
        run: |
          set -euo pipefail
          test -f "${{ matrix.capi_dir }}/${{ matrix.capi_file }}" || (echo "Missing CAPI at ${{ matrix.capi_dir }}/${{ matrix.capi_file }}" && exit 1)

          mkdir -p "$(dirname "${{ matrix.wrapper_out }}")"

          "${{ matrix.cc }}" -shared -fPIC -O2 -std=c++17 \
            -o "${{ matrix.wrapper_out }}" \
            "${{ env.CPP_SRC }}" \
            -I . \
            -I "${JAVA_HOME}/include" \
            -I "${JAVA_HOME}/include/${{ matrix.java_os_include }}" \
            -I "${{ env.CAPI_INCLUDE }}" \
            -L "${{ matrix.capi_dir }}" -l${{ env.CAPI_LIB_NAME }} \
            -Wl,-rpath,'$ORIGIN' \
            -Wl,-rpath,@loader_path || \
          "${{ matrix.cc }}" -shared -fPIC -O2 -std=c++17 \
            -o "${{ matrix.wrapper_out }}" \
            "${{ env.CPP_SRC }}" \
            -I . \
            -I "${JAVA_HOME}/include" \
            -I "${JAVA_HOME}/include/${{ matrix.java_os_include }}" \
            -I "${{ env.CAPI_INCLUDE }}" \
            -L "${{ matrix.capi_dir }}" -l${{ env.CAPI_LIB_NAME }} \
            -Wl,-rpath,'$ORIGIN'

          file "${{ matrix.wrapper_out }}" || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenccWrapper-${{ matrix.platform }}
          path: ${{ matrix.wrapper_out }}
          if-no-files-found: error

  windows_collect:
    name: Windows x64 DLL (prebuilt)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify prebuilt DLL exists
        shell: bash
        run: |
          set -euo pipefail
          DLL_PATH="openccjni/src/main/resources/openccjni/natives/windows-x86_64/OpenccWrapper.dll"
          if [[ ! -f "$DLL_PATH" ]]; then
            echo "Prebuilt DLL not found at $DLL_PATH"
            exit 1
          fi
          ls -la "$(dirname "$DLL_PATH")"
          echo "Found $DLL_PATH"

      - name: Upload artifact (Windows .dll)
        uses: actions/upload-artifact@v4
        with:
          name: OpenccWrapper-windows-x86_64
          path: openccjni/src/main/resources/openccjni/natives/windows-x86_64/OpenccWrapper.dll
          if-no-files-found: error

  build_jar:
    name: Build JARs + CLI distributions (Java 8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Java 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "8"

      - name: Make Gradle wrapper executable
        shell: bash
        run: |
          set -euo pipefail
          if [ -f ./gradlew ]; then chmod +x ./gradlew; fi
          if [ -f openccjni/gradlew ]; then chmod +x openccjni/gradlew; fi
          if [ -f openccjni-cli/gradlew ]; then chmod +x openccjni-cli/gradlew; fi

      - name: Build all packages (openccjni + openccjni-cli)
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew clean test jar fatjar distTar distZip sourcesJar javadocJar --no-daemon --stacktrace

          echo "== Build outputs =="
          ls -la openccjni/build/libs || true
          ls -la openccjni-cli/build/libs || true
          ls -la openccjni-cli/build/distributions || true

      - name: Collect outputs into release-friendly folders
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p openccjni/libs openccjni-cli/libs openccjni-cli/distributions

          # Collect openccjni jars
          if compgen -G "openccjni/build/libs/*.jar" > /dev/null; then
            cp -v openccjni/build/libs/*.jar openccjni/libs/
          fi

          # Collect openccjni-cli jars (+ fatjar if it is a jar)
          if compgen -G "openccjni-cli/build/libs/*.jar" > /dev/null; then
            cp -v openccjni-cli/build/libs/*.jar openccjni-cli/libs/
          fi

          # Collect distributions and rename to add ".jvm" before extension
          if compgen -G "openccjni-cli/build/distributions/*" > /dev/null; then
            for f in openccjni-cli/build/distributions/*; do
              base="$(basename "$f")"
              case "$base" in
                *.zip)  new="${base%.zip}.jvm.zip" ;;
                *.tar)  new="${base%.tar}.jvm.tar" ;;
                *.tar.gz) new="${base%.tar.gz}.jvm.tar.gz" ;;
                *.tgz)  new="${base%.tgz}.jvm.tgz" ;;
                *)      new="$base" ;;
              esac
              cp -v "$f" "openccjni-cli/distributions/$new"
            done
          fi

          echo "== Collected =="
          find openccjni/libs -maxdepth 1 -type f -print || true
          find openccjni-cli/libs -maxdepth 1 -type f -print || true
          find openccjni-cli/distributions -maxdepth 1 -type f -print || true

      - name: Upload build artifacts (jars + distributions)
        uses: actions/upload-artifact@v4
        with:
          name: java-packages
          path: |
            openccjni/libs/**
            openccjni-cli/libs/**
            openccjni-cli/distributions/**
          if-no-files-found: error

  publish_release:
    name: Create GitHub release (auto prerelease if dashed tag)
    needs: [ build_natives, windows_collect, build_jar ]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare native bundles (include CAPI)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          echo "Artifacts tree:"
          find artifacts -maxdepth 4 -type f -print | sed 's/^/ - /' || true

          # Locate wrappers
          LINUX_SO="$(find artifacts -type f -name 'libOpenccWrapper.so' -print -quit || true)"
          MACOS_ARM64_DYLIB="$(find artifacts -type f -path '*macos-arm64*' -name 'libOpenccWrapper.dylib' -print -quit || true)"
          MACOS_X86_64_DYLIB="$(find artifacts -type f -path '*macos-x86_64*' -name 'libOpenccWrapper.dylib' -print -quit || true)"
          WIN_DLL="$(find artifacts -type f -name 'OpenccWrapper.dll' -print -quit || true)"

          # Fallback to repo resources if any are missing
          [ -z "${LINUX_SO}" ] && [ -f openccjni/src/main/resources/openccjni/natives/linux-x86_64/libOpenccWrapper.so ] \
            && LINUX_SO=openccjni/src/main/resources/openccjni/natives/linux-x86_64/libOpenccWrapper.so

          [ -z "${MACOS_ARM64_DYLIB}" ] && [ -f openccjni/src/main/resources/openccjni/natives/macos-arm64/libOpenccWrapper.dylib ] \
            && MACOS_ARM64_DYLIB=openccjni/src/main/resources/openccjni/natives/macos-arm64/libOpenccWrapper.dylib

          [ -z "${MACOS_X86_64_DYLIB}" ] && [ -f openccjni/src/main/resources/openccjni/natives/macos-x86_64/libOpenccWrapper.dylib ] \
            && MACOS_X86_64_DYLIB=openccjni/src/main/resources/openccjni/natives/macos-x86_64/libOpenccWrapper.dylib

          [ -z "${WIN_DLL}" ] && [ -f openccjni/src/main/resources/openccjni/natives/windows-x86_64/OpenccWrapper.dll ] \
            && WIN_DLL=openccjni/src/main/resources/openccjni/natives/windows-x86_64/OpenccWrapper.dll

          echo "Using:"
          echo " - linux so         : ${LINUX_SO:-<missing>}"
          echo " - macOS arm64 dylib: ${MACOS_ARM64_DYLIB:-<missing>}"
          echo " - macOS x86_64 dylib: ${MACOS_X86_64_DYLIB:-<missing>}"
          echo " - windows dll      : ${WIN_DLL:-<missing>}"

          [ -n "${LINUX_SO:-}" ] || { echo "ERROR: Linux wrapper missing"; exit 1; }
          [ -n "${MACOS_ARM64_DYLIB:-}" ] || { echo "ERROR: macOS arm64 wrapper missing"; exit 1; }
          [ -n "${MACOS_X86_64_DYLIB:-}" ] || { echo "ERROR: macOS x86_64 wrapper missing"; exit 1; }
          [ -n "${WIN_DLL:-}" ] || { echo "ERROR: Windows wrapper missing"; exit 1; }

          mkdir -p bundle/linux-x86_64 bundle/macos-arm64 bundle/macos-x86_64 bundle/windows-x86_64
          cp "${LINUX_SO}"           bundle/linux-x86_64/
          cp "${MACOS_ARM64_DYLIB}"  bundle/macos-arm64/
          cp "${MACOS_X86_64_DYLIB}" bundle/macos-x86_64/
          cp "${WIN_DLL}"            bundle/windows-x86_64/

          # Include CAPI from resources
          cp openccjni/src/main/resources/openccjni/natives/linux-x86_64/libopencc_fmmseg_capi.so       bundle/linux-x86_64/
          cp openccjni/src/main/resources/openccjni/natives/macos-arm64/libopencc_fmmseg_capi.dylib     bundle/macos-arm64/
          cp openccjni/src/main/resources/openccjni/natives/macos-x86_64/libopencc_fmmseg_capi.dylib    bundle/macos-x86_64/
          cp openccjni/src/main/resources/openccjni/natives/windows-x86_64/opencc_fmmseg_capi.dll       bundle/windows-x86_64/

          for P in linux-x86_64 macos-arm64 macos-x86_64 windows-x86_64; do
            cat > "bundle/$P/README.txt" <<EOF
          OpenccJNI natives for ${P} (${TAG})

          Contents:
            - Wrapper: OpenccWrapper.{so|dylib|dll}
            - CAPI:    opencc_fmmseg_capi.{so|dylib|dll}

          Place both files in the same directory at runtime.
          If embedding in JAR, use: /openccjni/natives/${P}/
          EOF
          done

      - name: Create ZIP bundles
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          mkdir -p dist

          (cd bundle/linux-x86_64   && zip -9r "../OpenccJNI-natives-${TAG}-linux-x86_64.zip" .)
          (cd bundle/macos-arm64    && zip -9r "../OpenccJNI-natives-${TAG}-macos-arm64.zip" .)
          (cd bundle/macos-x86_64   && zip -9r "../OpenccJNI-natives-${TAG}-macos-x86_64.zip" .)
          (cd bundle/windows-x86_64 && zip -9r "../OpenccJNI-natives-${TAG}-windows-x86_64.zip" .)

          mv bundle/*.zip dist/
          ls -l dist

      - name: Collect Java artifacts (openccjni + openccjni-cli)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/openccjni/libs dist/openccjni-cli/libs dist/openccjni-cli/distributions

          # From downloaded artifact "java-packages"
          if compgen -G "artifacts/java-packages/openccjni/libs/*" > /dev/null; then
            cp -v artifacts/java-packages/openccjni/libs/* dist/openccjni/libs/
          fi
          if compgen -G "artifacts/java-packages/openccjni-cli/libs/*" > /dev/null; then
            cp -v artifacts/java-packages/openccjni-cli/libs/* dist/openccjni-cli/libs/
          fi
          if compgen -G "artifacts/java-packages/openccjni-cli/distributions/*" > /dev/null; then
            cp -v artifacts/java-packages/openccjni-cli/distributions/* dist/openccjni-cli/distributions/
          fi

          echo "== dist tree =="
          find dist -maxdepth 3 -type f -print | sed 's/^/ - /' || true

          # Hard fail if nothing collected
          if ! compgen -G "dist/openccjni/libs/*.jar" > /dev/null; then
            echo "ERROR: No openccjni jars collected"
            exit 1
          fi
          if ! compgen -G "dist/openccjni-cli/libs/*.jar" > /dev/null; then
            echo "ERROR: No openccjni-cli jars collected"
            exit 1
          fi
          if ! compgen -G "dist/openccjni-cli/distributions/*" > /dev/null; then
            echo "ERROR: No openccjni-cli distributions collected"
            exit 1
          fi

      - name: Create release (prerelease only if tag has '-')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ contains(github.ref_name, '-') && format('{0} (preview)', github.ref_name) || github.ref_name }}
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            dist/OpenccJNI-natives-${{ github.ref_name }}-linux-x86_64.zip
            dist/OpenccJNI-natives-${{ github.ref_name }}-macos-arm64.zip
            dist/OpenccJNI-natives-${{ github.ref_name }}-macos-x86_64.zip
            dist/OpenccJNI-natives-${{ github.ref_name }}-windows-x86_64.zip
            dist/openccjni/libs/*.jar
            dist/openccjni-cli/libs/*.jar
            dist/openccjni-cli/distributions/*