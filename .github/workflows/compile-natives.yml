# filename: .github/workflows/compile-natives.yml
name: Compile OpenccJNI Natives

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  # JNI sources live alongside Java in the openccjni package dir
  CPP_SRC: openccjni/src/main/java/openccjni/OpenccWrapper.cpp
  JAVA_SRC_CLASS: openccjni/src/main/java/openccjni/OpenccWrapper.java

  # C headers (generated + capi header) live with java sources
  CAPI_INCLUDE: openccjni/src/main/java/openccjni

  # Link against the CAPI that is shipped under resources
  LINUX_LIB_DIR: openccjni/src/main/resources/openccjni/natives/linux-x86_64
  MACOS_ARM64_LIB_DIR: openccjni/src/main/resources/openccjni/natives/macos-arm64
  WINDOWS_X86_64_LIB_DIR: openccjni/src/main/resources/openccjni/natives/windows-x86_64

  # Library name for -l<name>
  CAPI_LIB_NAME: opencc_fmmseg_capi

jobs:
  linux:
    name: Linux x86_64 (.so)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zip

      - name: Generate JNI header (optional)
        shell: bash
        run: |
          set -euo pipefail
          javac -h . "${{ env.JAVA_SRC_CLASS }}"
          test -f openccjni_OpenccWrapper.h || (echo "JNI header not generated" && exit 1)

      - name: Build libOpenccWrapper.so
        shell: bash
        run: |
          set -euo pipefail
          test -f "${{ env.LINUX_LIB_DIR }}/lib${{ env.CAPI_LIB_NAME }}.so" || (echo "Missing CAPI .so" && exit 1)

          mkdir -p artifacts/linux-x86_64

          g++ -shared -fPIC -O2 -std=c++17 \
            -o artifacts/linux-x86_64/libOpenccWrapper.so \
            "${{ env.CPP_SRC }}" \
            -I . \
            -I "${JAVA_HOME}/include" \
            -I "${JAVA_HOME}/include/linux" \
            -I "${{ env.CAPI_INCLUDE }}" \
            -L "${{ env.LINUX_LIB_DIR }}" -l${{ env.CAPI_LIB_NAME }} \
            -Wl,-rpath,'$ORIGIN'

          # Zip wrapper only (CAPI already lives in resources in your repo)
          (cd artifacts/linux-x86_64 && zip -9 OpenccJNI-natives-linux-x86_64.zip libOpenccWrapper.so)

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJNI-natives-linux-x86_64
          path: artifacts/linux-x86_64/OpenccJNI-natives-linux-x86_64.zip
          if-no-files-found: error

  macos_arm64:
    name: macOS arm64 (.dylib)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Generate JNI header (optional)
        shell: bash
        run: |
          set -euo pipefail
          javac -h . "${{ env.JAVA_SRC_CLASS }}"
          test -f openccjni_OpenccWrapper.h || (echo "JNI header not generated" && exit 1)

      - name: Build libOpenccWrapper.dylib
        shell: bash
        run: |
          set -euo pipefail
          test -f "${{ env.MACOS_ARM64_LIB_DIR }}/lib${{ env.CAPI_LIB_NAME }}.dylib" || (echo "Missing CAPI .dylib" && exit 1)

          mkdir -p artifacts/macos-arm64

          clang++ -shared -fPIC -O2 -std=c++17 \
            -o artifacts/macos-arm64/libOpenccWrapper.dylib \
            "${{ env.CPP_SRC }}" \
            -I . \
            -I "${JAVA_HOME}/include" \
            -I "${JAVA_HOME}/include/darwin" \
            -I "${{ env.CAPI_INCLUDE }}" \
            -L "${{ env.MACOS_ARM64_LIB_DIR }}" -l${{ env.CAPI_LIB_NAME }} \
            -Wl,-rpath,@loader_path

          (cd artifacts/macos-arm64 && zip -9 OpenccJNI-natives-macos-arm64.zip libOpenccWrapper.dylib)

      - name: Upload artifact (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJNI-natives-macos-arm64
          path: artifacts/macos-arm64/OpenccJNI-natives-macos-arm64.zip
          if-no-files-found: error

  windows_x86_64_mingw:
    name: Windows x86_64 (.dll, built on Ubuntu, dyn CAPI + static libstdc++/libgcc)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install MinGW-w64
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 binutils-mingw-w64 zip

      - name: Generate JNI header (optional)
        shell: bash
        run: |
          set -euo pipefail
          javac -h . "${{ env.JAVA_SRC_CLASS }}"
          test -f openccjni_OpenccWrapper.h || (echo "JNI header not generated" && exit 1)

      - name: Build OpenccWrapper.dll (Win7 floor)
        shell: bash
        run: |
          set -euo pipefail

          DLL="${{ env.WINDOWS_X86_64_LIB_DIR }}/${{ env.CAPI_LIB_NAME }}.dll"
          test -f "${DLL}" || (echo "Missing CAPI DLL: ${DLL}" && exit 1)

          # Copy needed inputs into a build CWD (matches your "everything in CWD" style)
          mkdir -p build/windows-x86_64
          cp -f "${{ env.CPP_SRC }}" build/windows-x86_64/OpenccWrapper.cpp
          cp -f "${{ env.CAPI_INCLUDE }}/opencc_fmmseg_capi.h" build/windows-x86_64/opencc_fmmseg_capi.h
          cp -f openccjni_OpenccWrapper.h build/windows-x86_64/openccjni_OpenccWrapper.h
          cp -f "${DLL}" build/windows-x86_64/${{ env.CAPI_LIB_NAME }}.dll          

          cd build/windows-x86_64
          cp -r "${GITHUB_WORKSPACE}/${{ env.CAPI_INCLUDE }}/jni-headers" .

          # Create import lib for dynamic linking
          # gendef "${{ env.CAPI_LIB_NAME }}.dll"  
          # x86_64-w64-mingw32-dlltool -d "${{ env.CAPI_LIB_NAME }}.def" -l "lib${{ env.CAPI_LIB_NAME }}.dll.a"
          # Create import lib for dynamic linking (needs exports -> .def)
          command -v gendef >/dev/null 2>&1 || (echo "gendef not found; install mingw-w64-tools" && exit 1)
  
          gendef opencc_fmmseg_capi.dll
          # produces: opencc_fmmseg_capi.def
  
          x86_64-w64-mingw32-dlltool -d opencc_fmmseg_capi.def -l libopencc_fmmseg_capi.dll.a
  
          ls -la
          ls -la libopencc_fmmseg_capi.dll.a
          x86_64-w64-mingw32-nm -g libopencc_fmmseg_capi.dll.a | head  
  
          # Build wrapper: CAPI dynamic, runtimes static
          x86_64-w64-mingw32-g++ -shared -O2 -std=c++17 \
            -D_WIN32_WINNT=0x0601 \
            -static-libstdc++ -static-libgcc -s \
            -o OpenccWrapper.dll OpenccWrapper.cpp \
            -I . \
            -I "./jni-headers/include" \
            -I "./jni-headers/include/win32" \
            -L . -l${{ env.CAPI_LIB_NAME }}

          mkdir -p "${GITHUB_WORKSPACE}/artifacts/windows-x86_64"
          cp -f OpenccWrapper.dll "${GITHUB_WORKSPACE}/artifacts/windows-x86_64/"
          # optional convenience copy (so the zip is runnable immediately)
          cp -f "${{ env.CAPI_LIB_NAME }}.dll" "${GITHUB_WORKSPACE}/artifacts/windows-x86_64/"

          (cd "${GITHUB_WORKSPACE}/artifacts/windows-x86_64" && zip -9 OpenccJNI-natives-windows-x86_64.zip ./*)

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJNI-natives-windows-x86_64
          path: artifacts/windows-x86_64/OpenccJNI-natives-windows-x86_64.zip
          if-no-files-found: error
