name: Build OpenccWrapper natives

on:
  push:
    tags:
      - 'v*'     # e.g. v1.0.0-beta1
  workflow_dispatch:

permissions:
  contents: read

env:
  # JNI sources live alongside Java in the opencc package dir
  CPP_SRC: openccjni/src/main/java/opencc/OpenccWrapper.cpp
  JAVA_SRC_CLASS: openccjni/src/main/java/opencc/OpenccWrapper.java

  # Headers and prebuilt CAPI libs are also in this dir (per your tree)
  CAPI_INCLUDE: openccjni/src/main/java/opencc
  LINUX_LIB_DIR: openccjni/src/main/java/opencc
  MACOS_ARM64_LIB_DIR: openccjni/src/main/java/opencc

  # Library name for -l<name> (maps to libopencc_fmmseg_capi.{so,dylib})
  CAPI_LIB_NAME: opencc_fmmseg_capi

jobs:
  linux:
    name: Linux x86_64 .so
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zip   # include zip explicitly

      - name: Show tree for sanity
        run: |
          ls -la .
          ls -la openccjni/src/main/java/opencc || true

      - name: Generate JNI header (optional)
        run: |
          javac -h . "${{ env.JAVA_SRC_CLASS }}"

      - name: Build libOpenccWrapper.so
        run: |
          test -f "${{ env.LINUX_LIB_DIR }}/libopencc_fmmseg_capi.so" || (echo "Missing CAPI at ${{ env.LINUX_LIB_DIR }}/libopencc_fmmseg_capi.so" && exit 1)
          mkdir -p build/linux-x86_64
          g++ -shared -fPIC -O2 -std=c++17 \
            -o build/linux-x86_64/libOpenccWrapper.so \
            "${{ env.CPP_SRC }}" \
            -I . \
            -I "${JAVA_HOME}/include" \
            -I "${JAVA_HOME}/include/linux" \
            -I "${{ env.CAPI_INCLUDE }}" \
            -L "${{ env.LINUX_LIB_DIR }}" -l${{ env.CAPI_LIB_NAME }} \
            -Wl,-rpath,'$ORIGIN'
          file build/linux-x86_64/libOpenccWrapper.so

      - name: Upload artifact (Linux .so)
        uses: actions/upload-artifact@v4
        with:
          name: OpenccWrapper-linux-x86_64
          path: build/linux-x86_64/libOpenccWrapper.so
          if-no-files-found: error

  macos_arm64:
    name: macOS arm64 .dylib
    runs-on: macos-14  # Apple Silicon
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Show tree for sanity
        run: |
          ls -la .
          ls -la openccjni/src/main/java/opencc || true

      - name: Generate JNI header (optional)
        run: |
          javac -h . "${{ env.JAVA_SRC_CLASS }}"

      - name: Build libOpenccWrapper.dylib
        run: |
          test -f "${{ env.MACOS_ARM64_LIB_DIR }}/libopencc_fmmseg_capi.dylib" || (echo "Missing CAPI at ${{ env.MACOS_ARM64_LIB_DIR }}/libopencc_fmmseg_capi.dylib" && exit 1)
          mkdir -p build/macos-arm64
          clang++ -shared -fPIC -O2 -std=c++17 \
            -o build/macos-arm64/libOpenccWrapper.dylib \
            "${{ env.CPP_SRC }}" \
            -I . \
            -I "${JAVA_HOME}/include" \
            -I "${JAVA_HOME}/include/darwin" \
            -I "${{ env.CAPI_INCLUDE }}" \
            -L "${{ env.MACOS_ARM64_LIB_DIR }}" -l${{ env.CAPI_LIB_NAME }} \
            -Wl,-rpath,@loader_path
          file build/macos-arm64/libOpenccWrapper.dylib

      - name: Upload artifact (macOS .dylib)
        uses: actions/upload-artifact@v4
        with:
          name: OpenccWrapper-macos-arm64
          path: build/macos-arm64/libOpenccWrapper.dylib
          if-no-files-found: error

  windows_collect:
    name: Windows x64 DLL (prebuilt)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify prebuilt DLL exists
        shell: bash
        run: |
          DLL_PATH="openccjni/src/main/resources/opencc/natives/windows-x86_64/OpenccWrapper.dll"
          if [[ ! -f "$DLL_PATH" ]]; then
            echo "Prebuilt DLL not found at $DLL_PATH"
            exit 1
          fi
          ls -la "$(dirname "$DLL_PATH")"
          echo "Found $DLL_PATH"

      - name: Upload artifact (Windows .dll)
        uses: actions/upload-artifact@v4
        with:
          name: OpenccWrapper-windows-x86_64
          path: openccjni/src/main/resources/opencc/natives/windows-x86_64/OpenccWrapper.dll
          if-no-files-found: error

  publish_release:
    name: Create GitHub release (auto prerelease if dashed tag)
    needs: [ linux, macos_arm64, windows_collect ]
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download wrapper artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Prepare bundles (include CAPI)
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Staging
          mkdir -p bundle/linux-x86_64 bundle/macos-arm64 bundle/windows-x86_64

          # Wrappers from artifacts
          cp release_assets/OpenccWrapper-linux-x86_64/libOpenccWrapper.so      bundle/linux-x86_64/
          cp release_assets/OpenccWrapper-macos-arm64/libOpenccWrapper.dylib   bundle/macos-arm64/
          cp release_assets/OpenccWrapper-windows-x86_64/OpenccWrapper.dll     bundle/windows-x86_64/

          # CAPI from resources
          cp openccjni/src/main/resources/opencc/natives/linux-x86_64/libopencc_fmmseg_capi.so     bundle/linux-x86_64/
          cp openccjni/src/main/resources/opencc/natives/macos-arm64/libopencc_fmmseg_capi.dylib   bundle/macos-arm64/
          cp openccjni/src/main/resources/opencc/natives/windows-x86_64/opencc_fmmseg_capi.dll     bundle/windows-x86_64/

          # Tiny README
          for P in linux-x86_64 macos-arm64 windows-x86_64; do
            cat > "bundle/$P/README.txt" <<EOF
            OpenccJNI natives for ${P} (${TAG})

          Contents:
            - Wrapper: OpenccWrapper.{so|dylib|dll}
            - CAPI:    opencc_fmmseg_capi.{so|dylib|dll}
            
          Place both files in the same directory at runtime.
          If embedding in JAR, use: /opencc/natives/${P}/
          EOF
          done

      - name: Create ZIP bundles
        run: |
          TAG="${GITHUB_REF_NAME}"
          mkdir -p dist
          (cd bundle/linux-x86_64  && zip -9r "../OpenccJNI-natives-${TAG}-linux-x86_64.zip" .)
          (cd bundle/macos-arm64   && zip -9r "../OpenccJNI-natives-${TAG}-macos-arm64.zip" .)
          (cd bundle/windows-x86_64&& zip -9r "../OpenccJNI-natives-${TAG}-windows-x86_64.zip" .)
          mv bundle/*.zip dist/
          ls -l dist

      - name: Create release (prerelease only if tag has '-')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ contains(github.ref_name, '-') && format('{0} (preview)', github.ref_name) || github.ref_name }}
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            dist/OpenccJNI-natives-${{ github.ref_name }}-linux-x86_64.zip
            dist/OpenccJNI-natives-${{ github.ref_name }}-macos-arm64.zip
            dist/OpenccJNI-natives-${{ github.ref_name }}-windows-x86_64.zip
